
<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <link rel="shortcut icon" href="../assets/images/favicon.png">
      
      <meta name="generator" content="mkdocs-0.16.3, mkdocs-material-1.10.1">
    
    
      
        <title>Producers and Consumers - Hollow (Netflix OSS)</title>
      
    
    
      <script src="../assets/javascripts/modernizr-e826f8942a.js"></script>
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application-a20f419c8e.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-23f75ab9c7.palette.css">
      
    
    
      
        
        
        
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
    
  </head>
  
  
  
  
    <body data-md-color-primary="red" data-md-color-accent="brown">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Hollow (Netflix OSS)" class="md-header-nav__button md-logo">
          
            <i class="md-icon md-icon--home"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <span class="md-flex__ellipsis md-header-nav__title">
          
            
              
            
            Producers and Consumers
          
        </span>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" required placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset">&#xE5CD;</button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result" data-md-lang-search="" data-md-lang-tokenizer="[\s\-]+">
          <div class="md-search-result__meta" data-md-lang-result-none="No matching documents" data-md-lang-result-one="1 matching document" data-md-lang-result-other="# matching documents">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/Netflix/hollow" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <div class="md-nav__button md-logo">
      
        <i class="md-icon md-icon--home"></i>
      
    </div>
    Hollow (Netflix OSS)
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/Netflix/hollow" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../quick-start/" title="Quick Start" class="md-nav__link">
      Quick Start
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../getting-started/" title="Getting Started" class="md-nav__link">
      Getting Started
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../indexing-querying/" title="Indexing/Querying" class="md-nav__link">
      Indexing/Querying
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Producers and Consumers
      </label>
    
    <a href="./" title="Producers and Consumers" class="md-nav__link md-nav__link--active">
      Producers and Consumers
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#storing-the-blobs" title="Storing the Blobs" class="md-nav__link">
    Storing the Blobs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#announcing-the-state" title="Announcing the State" class="md-nav__link">
    Announcing the State
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pinning-consumers" title="Pinning Consumers" class="md-nav__link">
    Pinning Consumers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#blob-namespaces" title="Blob Namespaces" class="md-nav__link">
    Blob Namespaces
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../tooling/" title="Tooling" class="md-nav__link">
      Tooling
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../data-modeling/" title="Data Modeling" class="md-nav__link">
      Data Modeling
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../diving-deeper/" title="Diving Deeper" class="md-nav__link">
      Diving Deeper
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../interacting-with-a-dataset/" title="Interacting with a Hollow Dataset" class="md-nav__link">
      Interacting with a Hollow Dataset
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../data-ingestion/" title="Data Ingestion" class="md-nav__link">
      Data Ingestion
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../advanced-topics/" title="Advanced Topics" class="md-nav__link">
      Advanced Topics
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../glossary/" title="Glossary" class="md-nav__link">
      Glossary
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../community/" title="Community" class="md-nav__link">
      Community
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../acknowledgements/" title="Acknowledgements" class="md-nav__link">
      Acknowledgements
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../license/" title="License" class="md-nav__link">
      License
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#storing-the-blobs" title="Storing the Blobs" class="md-nav__link">
    Storing the Blobs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#announcing-the-state" title="Announcing the State" class="md-nav__link">
    Announcing the State
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pinning-consumers" title="Pinning Consumers" class="md-nav__link">
    Pinning Consumers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#blob-namespaces" title="Blob Namespaces" class="md-nav__link">
    Blob Namespaces
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/Netflix/hollow/edit/master/docs/producer-consumer.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="infrastructure-integration">Infrastructure Integration</h1>
<p>In order to wield Hollow effectively for your organization, you need only implement four interfaces to integrate with your infrastructure:</p>
<ul>
<li>A <code>Publisher</code> for the <code>HollowProducer</code></li>
<li>An <code>Announcer</code> for the <code>HollowProducer</code></li>
<li>A <code>BlobRetriever</code> for the <code>HollowConsumer</code></li>
<li>An <code>AnnouncementWatcher</code> for the <code>HollowConsumer</code></li>
</ul>
<p>Once you've implemented these four interfaces, Hollow can be used in many different contexts in your organization.  You'll never again have to write code to ship json or csv data from one machine to another -- and better yet, you'll gain visibility and insights into previously opaque and hard-to-debug datasets.</p>
<div class="admonition hint">
<p class="admonition-title">Think local first</p>
<p>The following sections describe how to plug Hollow into your infrastructure.  Now is the time to think about how you will debug your data later.  Consider making your implementations of these interfaces easily allow for (securely!) retrieving data from any environment, including production, right down to your local development box.</p>
<p>If you take this step, you'll be giving yourself immense power to glean insight into your data and debug production issues.  Imagine it's 10am, and you suspect some issue surrounding some particular data was present at 4am this morning.  You can open up Eclipse or IntelliJ and write a main method which -- with a few lines of code -- pulls down the data <em>exactly</em> as it existed on your production instances at that time.  You can write code against it to explore specific scenarios or feed it into the <a href="../tooling/#hollow-explorer">explorer</a> to confirm or deny your suspicion in seconds.</p>
</div>
<h2 id="storing-the-blobs">Storing the Blobs</h2>
<p>Blobs are published to a file store which is accessible by consumers.  From this blob store, consumers must be able to query for and retrieve blobs in the following ways:</p>
<ul>
<li><strong>Snapshots</strong>: Must be queryable based on the state identifier.  If a blob store is queried for a snapshot with an identifier which does not exist, the snapshot with the greatest identifier prior to the queried identifier should be retrieved.</li>
<li><strong>Deltas</strong>: Must be queryable based on the state identifier to which a delta should be applied (e.g. the delta's <strong>from</strong> state identifier).</li>
<li><strong>Reverse Deltas</strong>: Must be queryable based on the state identifier to which a reverse delta should be applied (e.g. the reverse delta's <strong>from</strong> state identifier).</li>
</ul>
<p>The <code>Publisher</code> and <code>BlobRetriever</code> are opposite sides of your blob store (writer and reader, respectively).</p>
<p>Your <code>Publisher</code> implementation must only define a single method:</p>
<div class="codehilite"><pre><span></span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">publish</span><span class="o">(</span><span class="n">HollowProducer</span><span class="o">.</span><span class="na">Blob</span> <span class="n">blob</span><span class="o">);</span>
</pre></div>


<p>The <code>Blob</code> passed to your <code>Publisher</code> should be published somewhere for retrieval by consumers.  The blob's data is retrieved for publish by calling either <code>newInputStream()</code> or <code>getFile()</code>.  The blob will be one of either a <em>snapshot</em>, <em>delta</em>, or <em>reverse delta</em> -- the type can be determined by calling <code>getType()</code>.  The blob should be indexed for later retrieval as indicated above -- <em>snapshots</em> by the result of <code>getToVersion()</code>, and <em>deltas</em>/<em>reversedeltas</em> by the result of <code>getFromVersion()</code>.  Note that you will need to be able to distinguish between a <em>snapshot</em>, <em>delta</em>, and <em>reversedelta</em> with the same version number.  </p>
<div class="admonition note">
<p class="admonition-title">Choosing a blob store</p>
<p>You can publish blobs anywhere -- S3, an FTP server, an NFS, etc -- so long as that selected blob store can scale to the necessary volume of concurrent consumer requests.  </p>
<p>Note that if your announcement mechanism is instantaneous all consumers will attempt to retrieve the blob files simultaneously.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Blobs must be overwriteable</p>
<p>Your <code>Publisher</code> implementation must allow blobs to be overwritten.  If an attempt is made to publish a blob with to be indexed by a state identifier for which a corresponding artifact already exists, it must <em>overwrite</em> the existing artifact previously published.  This happens routinely -- for example if a data state fails after publishing for any reason (e.g. validation fails), then the producer will automatically roll back the state and a delta will be re-published with the same <em>from</em> version.</p>
</div>
<p>The <code>BlobRetriever</code> is the other side of the blob store equation.  Your implementation must define three methods:</p>
<div class="codehilite"><pre><span></span>    <span class="kd">public</span> <span class="n">HollowConsumer</span><span class="o">.</span><span class="na">Blob</span> <span class="nf">retrieveSnapshotBlob</span><span class="o">(</span><span class="kt">long</span> <span class="n">desiredVersion</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">HollowConsumer</span><span class="o">.</span><span class="na">Blob</span> <span class="nf">retrieveDeltaBlob</span><span class="o">(</span><span class="kt">long</span> <span class="n">currentVersion</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">HollowConsumer</span><span class="o">.</span><span class="na">Blob</span> <span class="nf">retrieveReverseDeltaBlob</span><span class="o">(</span><span class="kt">long</span> <span class="n">currentVersion</span><span class="o">);</span>
</pre></div>


<p>The <code>Blob</code> you return will be a custom implementation for your blob store which extends <code>HollowConsumer.Blob</code> and implements the <code>getInputStream()</code> method.  </p>
<p>Your <code>retrieveSnapshotBlob(long desiredVersion)</code> implementation should return the blob which exactly matches the specified <code>desiredVersion</code> if it exists.  If no such version exists then the greatest available version which is <em>less than</em> the specified <code>desiredVersion</code> should be returned.  If no such match exists, return null.</p>
<p>Your <code>retrieveDeltaBlob(long currentVersion)</code> and <code>retrieveReverseDeltaBlob(long currentVersion)</code> implementations should each return the blob which exactly matches the specified <code>currentVersion</code>.  If no such match exists, return null.</p>
<div class="admonition hint">
<p class="admonition-title">Scanning for snapshots</p>
<p>If an exact match for the requested snapshot doesn't exist, you'll need to scan the available versions for the closest match prior to the requested.  For this reason, if you have a large number of consumers, it makes sense to <em>index</em> your available snapshot versions so this operation is fast.</p>
</div>
<h2 id="announcing-the-state">Announcing the State</h2>
<p>Once the necessary transitions to bring clients up to date have been written to the blob store, the availability of the state must be <em>announced</em> to clients.  This simply means that a centralized location must be maintained and updated by the producer which indicates the version of the currently available state.  </p>
<p>When this announced state is updated, usually it is desirable to have consumers realize this update as quickly as possible.  This can be accomplished either via a push notification to all consumers, or via frequent polling by consumers.</p>
<p>The <code>Announcer</code> and <code>AnnouncementWatcher</code> are opposite sides of your announcement mechanism (writer and reader, respectively).</p>
<p>Your <code>Announcer</code> implementation must only implement a single method:</p>
<div class="codehilite"><pre><span></span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">announce</span><span class="o">(</span><span class="kt">long</span> <span class="n">stateVersion</span><span class="o">);</span>
</pre></div>


<p>The <code>stateVersion</code> passed to your <code>Announcer</code> should be immediately communicated to your consumers.  You can use either a 'push' mechanism or a frequent 'polling' mechanism to minimize the time between when a producer announces a version, and all consumers receive that announcement.</p>
<p>Your <code>AnnouncementWatcher</code> implementation must implement two methods:</p>
<div class="codehilite"><pre><span></span>    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getLatestVersion</span><span class="o">();</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">subscribeToUpdates</span><span class="o">(</span><span class="n">HollowConsumer</span> <span class="n">consumer</span><span class="o">);</span>
</pre></div>


<p>When your <code>AnnouncementWatcher</code> is initialized, you should immediately set up your selected announcement mechanism -- either subscribe to your push notifications or set up a thread to poll for updates.  </p>
<p>Implementations should maintain a list of subscribed <code>HollowConsumer</code>s, and each time <code>subcribeToUpdates(HollowConsumer consumer)</code> is called, you should add the provided <code>HollowConsumer</code> to your list.  When the announced version changes, call <code>triggerAsyncRefresh()</code> on each subscribed consumer.</p>
<p>Whether or not any <code>HollowConsumer</code>s are subscribed, implementations should return the latest announced version each time <code>getLatestVersion()</code> is called.</p>
<div class="admonition note">
<p class="admonition-title">HollowConsumer subscribes itself</p>
<p>A <code>HollowConsumer</code> will automatically call <code>subscribeToUpdates()</code> with itself for an <code>AnnouncementWatcher</code> with which it is initialized.</p>
</div>
<h3 id="pinning-consumers">Pinning Consumers</h3>
<p>Mistakes happen.  What's important is that we can recover from them quickly.  If you accidentally publish bad data, you should be able to revert those changes quickly.  If you give your <code>AnnouncementWatcher</code> implementation an alternate location to read the announcement from, which <em>overrides</em> the announcement from the consumer, then you can use this to quickly force clients to go back to any arbitrary state in the past.  We call setting a state version in this alternate location <em>pinning</em> the consumers.</p>
<p>Implementing a pinning mechanism is extremely useful and highly recommended.  You can operationally reverse data issues immediately upon discovery, so that symptoms go away while you diagnose exactly what went wrong.  This can save an enormous amount of stress and money.</p>
<div class="admonition danger">
<p class="admonition-title">Unpinning</p>
<p>If you've pinned consumers due to a data issue, it's probably not desirable to simply 'unpin' them after the root cause is addressed.  Instead, restart the producer and instruct it to <a href="#restoring-at-startup">restore</a> from the pinned state.  It should then produce a delta which skips over all of the bad states.  Only unpin after the delta from the pinned version to a bad version is overwritten with a delta from the pinned version to the good version.</p>
</div>
<h3 id="blob-namespaces">Blob Namespaces</h3>
<p>Different use cases within your organization may want to reuse the same infrastructure integration.  You may want your <code>BlobRetriever</code> and <code>AnnouncementWatcher</code> to allow for multiple blob <em>namespaces</em>, one for each use case.</p>
<h1 id="the-producerconsumer-apis">The Producer/Consumer APIs</h1>
<p>In <a href="../getting-started/">Getting Started</a> we encountered basic usage of the <code>HollowProducer</code> and <code>HollowConsumer</code> APIs.  This basic usage implies some default behavior which, if desired, may be customized to better suit your purposes.  A more in-depth exploration of the available customizable features of these APIs follows.</p>
<h2 id="the-hollowproducer">The HollowProducer</h2>
<p>Generally, a producer runs a repeating <em>cycle</em>.  At the end of each cycle, the producer has created a <em>data state</em>, published the artifacts necessary for consumers to bring their in-memory data stores to that <em>data state</em>, and announced the availability of the <em>state</em>.</p>
<p>The <code>HollowProducer</code> encapsulates the details of publishing, announcing, validating, and (if necessary) rollback of data states.  In order to accomplish this, a few infrastructure hooks should be injected:</p>
<div class="codehilite"><pre><span></span><span class="n">HollowProducer</span>
   <span class="o">.</span><span class="na">withPublisher</span><span class="o">(</span><span class="n">publisher</span><span class="o">)</span>         <span class="c1">/// required: a BlobPublisher</span>
   <span class="o">.</span><span class="na">withAnnouncer</span><span class="o">(</span><span class="n">announcer</span><span class="o">)</span>         <span class="c1">/// optional: an Announcer</span>
   <span class="o">.</span><span class="na">withValidators</span><span class="o">(</span><span class="n">validators</span><span class="o">)</span>       <span class="c1">/// optional: one or more Validator</span>
   <span class="o">.</span><span class="na">withListeners</span><span class="o">(</span><span class="n">listeners</span><span class="o">)</span>         <span class="c1">/// optional: one or more HollowProducerListeners</span>
   <span class="o">.</span><span class="na">withBlobStagingDir</span><span class="o">(</span><span class="n">dir</span><span class="o">)</span>          <span class="c1">/// optional: a java.io.File</span>
   <span class="o">.</span><span class="na">withBlobCompressor</span><span class="o">(</span><span class="n">compressor</span><span class="o">)</span>   <span class="c1">/// optional: a BlobCompressor</span>
   <span class="o">.</span><span class="na">withBlobStager</span><span class="o">(</span><span class="n">stager</span><span class="o">)</span>           <span class="c1">/// optional: a BlobStager</span>
   <span class="o">.</span><span class="na">withSnapshotPublishExecutor</span><span class="o">(</span><span class="n">e</span><span class="o">)</span>   <span class="c1">/// optional: a java.util.concurrent.Executor</span>
   <span class="o">.</span><span class="na">withNumStatesBetweenSnapshots</span><span class="o">(</span><span class="n">n</span><span class="o">)</span> <span class="c1">/// optional: an int</span>
   <span class="o">.</span><span class="na">withTargetMaxTypeShardSize</span><span class="o">(</span><span class="n">size</span><span class="o">)</span> <span class="c1">/// optional: a long</span>
</pre></div>


<p>Let's examine each of the injected configurations into the <code>HollowProducer</code>:</p>
<ul>
<li><code>BlobPublisher</code>: Implementations of this class define how to publish blob data to the blob store.</li>
<li><code>Announcer</code>: Implementations of this class define the announcement mechanism, which is used to track the version of the currently announced state.</li>
<li><code>Validator</code>: Implementations of this class allow for semantic validation of the data contained in a state prior to announcement.  If an Exception is thrown during validation, the state will not be announced, and the producer will be automatically rolled back to the prior state.</li>
<li><code>HollowProducerListener</code>: Listeners are notified about the progress and status of producer cycles throughout the various cycle stages.</li>
<li><strong>Blob staging directory</strong>: Before blobs are published, they must be written and inspected/validated.  A directory may be specified as a File to which these "staged" blobs will be written prior to publish.  Staged blobs will be cleaned up automatically after publish.</li>
<li><code>BlobCompressor</code>: Implementations of this class intercept blob input/output streams to allow for compression in the blob store.</li>
<li><code>BlobStager</code>: Implementations will define how to stage blobs, if the default behavior of staging blobs on local disk is not desirable.  If a custom <code>BlobStager</code> is provided, then neither a blob staging directory or <code>BlobCompressor</code> should be provided.</li>
<li><strong>Snapshot publish</strong> <code>Executor</code>: When consumers start up, if the latest announced version does not have a snapshot, they can load an earlier snapshot and follow deltas to get up-to-date.  A state can therefore be available and announced prior to the availability of the snapshot.  If an Executor is supplied here, then it will be used to publish snapshots.  This can be useful if snapshot publishing takes a long time -- subsequent cycles may proceed while snapshot uploads are still in progress.</li>
<li><strong>Number of cycles between snapshots</strong>: Because snapshots are not necessary for a data state to be available and announced, they need not be published every cycle.  If this parameter is specified, then a snapshot will be produced only every <code>(n+1)th</code> cycle.</li>
<li><code>VersionMinter</code>: Allows for a custom version identifier minting strategy.</li>
<li><strong>Target max type shard size</strong>: Specify a <a href="../advanced-topics/#type-sharding">target max type shard size</a>.  Defaults to 16MB.</li>
</ul>
<p>Each time a new <em>data state</em> should be produced, users should call <code>.runCycle(Populator)</code>.  See <a href="../getting-started/">Getting Started</a> for more basic usage details.</p>
<h3 id="restoring-at-startup">Restoring At Startup</h3>
<p>Ideally the same <code>HollowProducer</code> would be held in memory forever, and <code>runCycle()</code> would be called every so often to produce a never-ending intact <em>delta chain</em>.  However, this isn’t always possible; the producer will need to be restarted from time to time due to deployment or other operational circumstances.</p>
<p>In order to produce a delta between states produced by one <code>HollowProducer</code> and another, the producer can <em>restore</em> the prior state upon restart, which will allow a delta and reverse delta to be produced.  See <a href="../getting-started/#restoring-at-startup">Restoring at Startup</a> for usage.</p>
<p>Once we have <em>restored</em> the prior state, we can produce a delta from our producer's first cycle.  The delta will be applicable to any consumers which are on the state from which we restored.  </p>
<div class="admonition hint">
<p class="admonition-title">Initializing Before Restore</p>
<p>Before <em>restoring</em>, we must always <em>initialize</em> our data model.  A <code>HollowProducer</code>'s data model may be initialized:</p>
<ul>
<li>via the <code>HollowObjectMapper</code> by calling <code>initTypeState()</code> with all top-level classes</li>
<li>via a set of schemas <a href="../advanced-topics/#schema-parser">loaded from a text file</a> using the <code>HollowSchemaParser</code> and <code>HollowWriteStateCreator</code></li>
</ul>
</div>
<div class="admonition note">
<p class="admonition-title">Truncating a Delta Chain</p>
<p>If a problem occurs and you need to <a href="#pinning-consumers">pin back</a> consumers, you <em>may</em> want to restart your producer and explicitly restore from the pinned state.  Once the producer's first cycle completes, it will publish a delta from the pinned state to the newly produced state, <em>overwriting</em> the previous delta from the pinned state.  In this way, when you unpin, consumers will automatically follow the <em>new</em> delta, and the old forward-path from the pinned state will be <em>truncated</em>.</p>
<p>If any consumers somehow did happen to remain on a <em>truncated</em> state, the reverse delta out of the truncated chain is still intact -- they could be manually pinned back to the restored state, then unpinned to get back up-to-date.</p>
</div>
<h3 id="rolling-back">Rolling Back</h3>
<p>While producing a new state, if the <code>HollowProducer</code> encounters an error during data state population or validation fails, the current <em>data state</em> will be aborted and the underlying <em>state engine</em> will be rolled back to the previous data state.  Any delta produced on the next cycle will be from the last <em>successful</em> data state.</p>
<h3 id="validating-data">Validating Data</h3>
<p>It likely makes sense to perform some basic <em>validation</em> on your produced data states before announcing them to clients.  If you provide one or more <code>Validator</code>s to the <code>HollowProducer</code>, these will be automatically executed prior to announcement.  Validation rules will be specific to the semantics of the dataset, and may include some heuristics-based metrics based on expectations about the dataset.  If your <code>Validator</code> throws an Exception, the <code>HollowProducer</code> will automatically roll back the state engine and the <em>next successful</em> cycle will produce a delta from the prior successful state.  </p>
<h3 id="compacting-data">Compacting Data</h3>
<p>It is possible to produce delta chains which extend over many thousands of states.  If during this delta chain an especially large delta happens for a specific type, it’s possible that many ordinal holes will be present in that type.  If over time multiple types go through especially large deltas, this can have an impact on a dataset’s heap footprint.</p>
<p>To reclaim heap space occupied by ordinal holes, a special <em>compaction cycle</em> can be run on the <code>HollowProducer</code>.  During compaction, no record data will change, but identical records will be relocated off of the high end of the ordinal space into the ordinal holes.  This is accomplished by producing a new data state with no changes except for the more optimal ordinal assignments.</p>
<p>To run a <em>compaction cycle</em>, call <code>runCompactionCycle(config)</code> on the <code>HollowProducer</code>.  If this method returns a valid version identifier, then a compaction cycle occurred and produced a new data state.  If it returns <code>Long.MIN_VALUE</code>, then the compaction criteria specified in the <code>CompactionConfig</code> was not met and no action was taken.  See the <code>HollowCompactor</code> javadoc for more details.</p>
<h2 id="the-hollowconsumer">The HollowConsumer</h2>
<p>Data consumers keep their local copy of a dataset current by ensuring that their state engine is always at the latest <em>announced</em> data state. Consumers can arrive at a particular data state in a couple of different ways:</p>
<ul>
<li>At initialization time, they will load a snapshot, which is an entire copy of the dataset to be forklifted into memory.</li>
<li>After initialization time, they will keep their local copy of the dataset current by applying delta transitions, which are the differences between adjacent data states.</li>
</ul>
<p>The <code>HollowConsumer</code> encapsulates the details of initializing and keeping a dataset up to date.  In order to accomplish this task, a few infrastructure hooks should be injected:</p>
<div class="codehilite"><pre><span></span><span class="n">HollowConsumer</span>
   <span class="o">.</span><span class="na">withBlobRetriever</span><span class="o">(</span><span class="n">blobRetriever</span><span class="o">)</span>              <span class="c1">/// required: a BlobRetriever</span>
   <span class="o">.</span><span class="na">withLocalBlobStore</span><span class="o">(</span><span class="n">localDiskDir</span><span class="o">)</span>              <span class="c1">/// optional: a local disk location</span>
   <span class="o">.</span><span class="na">withAnnouncementWatcher</span><span class="o">(</span><span class="n">announcementWatcher</span><span class="o">)</span>  <span class="c1">/// optional: a AnnouncementWatcher</span>
   <span class="o">.</span><span class="na">withRefreshListener</span><span class="o">(</span><span class="n">refreshListener</span><span class="o">)</span>          <span class="c1">/// optional: a RefreshListener</span>
   <span class="o">.</span><span class="na">withGeneratedAPIClass</span><span class="o">(</span><span class="n">MyGeneratedAPI</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>   <span class="c1">/// optional: a generated client API class</span>
   <span class="o">.</span><span class="na">withFilterConfig</span><span class="o">(</span><span class="n">filterConfig</span><span class="o">)</span>                <span class="c1">/// optional: a HollowFilterConfig</span>
   <span class="o">.</span><span class="na">withDoubleSnapshotConfig</span><span class="o">(</span><span class="n">doubleSnapshotCfg</span><span class="o">)</span>   <span class="c1">/// optional: a DoubleSnapshotConfig</span>
   <span class="o">.</span><span class="na">withObjectLongevityConfig</span><span class="o">(</span><span class="n">objectLongevityCfg</span><span class="o">)</span> <span class="c1">/// optional: an ObjectLongevityConfig</span>
   <span class="o">.</span><span class="na">withObjectLongevityDetector</span><span class="o">(</span><span class="n">detector</span><span class="o">)</span>         <span class="c1">/// optional: an ObjectLongevityDetector</span>
   <span class="o">.</span><span class="na">withRefreshExecutor</span><span class="o">(</span><span class="n">refreshExecutor</span><span class="o">)</span>          <span class="c1">/// optional: an Executor</span>
   <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</pre></div>


<p>Let's examine each the injected hooks to the <code>HollowConsumer</code>:</p>
<ul>
<li><code>BlobRetriever</code>: The interface to the blob store.  This is the only hook for which a custom implementation is required.  Each of the other hooks have default implementations which may be used.  The <code>BlobRetriever</code> may be omitted only if a previously-populated local blob store is specified.</li>
<li><strong>Local blob store</strong>: A <code>File</code> which indicates where to record downloaded blobs and find previously downloaded blobs.  If specified along with a <code>BlobRetriever</code>, the <code>HollowConsumer</code> will prefer to use previously downloaded blobs where applicable, and otherwise write newly downloaded blobs to the specified directory.  If specified <em>without</em> a <code>BlobRetriever</code>, only previously downloaded blobs will be available. </li>
<li><code>AnnouncementWatcher</code>: Provides an interface to the state announcement mechanism.  Often, announcement polling logic is encapsulated inside implementations.</li>
<li><code>RefreshListener</code>: Provides hooks so that actions may be taken during and after updates (e.g. indexing).</li>
<li><strong>Generated API Class</strong>: Specifies a <a href="../getting-started/#consumer-api-generation">custom-generated Hollow API</a> to use.</li>
<li><code>HollowFilterConfig</code>: </li>
<li><code>DoubleSnapshotConfig</code>: Defines advanced settings related to <a href="../advanced-topics/#double-snapshots">double snapshots</a>.</li>
<li><code>ObjectLongevityConfig</code>: Defines advanced settings related to <a href="../advanced-topics/#object-longevity">object longevity</a>.</li>
<li><code>ObjectLongevityDetector</code>: Implementations are notified when stale hollow object existence and usage is detected.</li>
<li><code>RefreshExecutor</code>: An <code>Executor</code> to use when asynchronous updates are called via <code>triggerAsyncRefresh()</code>.</li>
</ul>
<p>Each time the identifier of the currently announced state changes, <code>triggerRefresh()</code> should be called on the <code>HollowConsumer</code>.  This will bring the data up to date.</p>
<p>In general, the only requirement for getting Hollow consumers to work with your specific infrastructure is to implement a <code>BlobRetriever</code> and <code>AnnouncementWatcher</code>, and use them with a <code>HollowConsumer</code>.</p>
<div class="admonition hint">
<p class="admonition-title">Triggering Refresh</p>
<p>When implementing a <code>AnnouncementWatcher</code>, you will need to implement the method <code>subscribeToUpdates(HollowConsumer consumer)</code>.  When you
create a <code>HollowConsumer</code> with an <code>AnnouncementWatcher</code>, it will automatically call back to this method with itself as the argument.  </p>
<p>You should track all <code>HollowConsumer</code>s received by calls to this method.  When your announcement mechanism provides an updated value, 
you should notify each <code>HollowConsumer</code> via the <code>triggerAsyncRefresh()</code> method.</p>
<p>In this way, your <code>HollowConsumer</code> injected with this <code>HollowAnnouncementWatcher</code> implementation will be automatically kept up-to-date.</p>
</div>
<h3 id="dataset-consistency">Dataset Consistency</h3>
<p>If you have a long-running process which requires a consistent view of the dataset in a single state, you can prevent the <code>HollowConsumer</code> from updating while your process runs:</p>
<div class="codehilite"><pre><span></span><span class="n">HollowConsumer</span> <span class="n">consumer</span> <span class="o">=</span> <span class="o">...</span>

<span class="n">consumer</span><span class="o">.</span><span class="na">getRefreshLock</span><span class="o">().</span><span class="na">lock</span><span class="o">();</span>
<span class="k">try</span> <span class="o">{</span>
    <span class="c1">/// run your process</span>
<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
    <span class="n">consumer</span><span class="o">.</span><span class="na">getRefreshLock</span><span class="o">().</span><span class="na">unlock</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>


<p>The <code>getRefreshLock()</code> call returns the read lock in a <code>ReadWriteLock</code>.  Refreshes use the write lock.</p>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../indexing-querying/" title="Indexing/Querying" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Indexing/Querying
              </span>
            </div>
          </a>
        
        
          <a href="../tooling/" title="Tooling" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Tooling
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="http://www.mkdocs.org" title="MkDocs">MkDocs</a>
        and
        <a href="http://squidfunk.github.io/mkdocs-material/" title="Material for MkDocs">
          Material for MkDocs</a>
      </div>
      
        
  <div class="md-footer-social">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
      <a href="https://github.com/Netflix/hollow" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://gitter.im/Netflix/hollow" class="md-footer-social__link fa fa-gitter"></a>
    
  </div>

      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application-f3ab9e5ff8.js"></script>
      
      
      <script>app.initialize({url:{base:".."}})</script>
      
    
    
      
    
  </body>
</html>